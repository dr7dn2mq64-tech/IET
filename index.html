<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a1a">
    <title>ä¸§å°¸é€ƒç”Ÿ - å…¨å¹³å°ç‰ˆ</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuivt+iHquWKqOivgeWNjiIsCiAgInNob3J0X25hbWUiOiAi6K+36Ieq5Yqo6K+B5Y2OIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxYTFhMWEiLAogICJ0aGVtZV9jb2xvciI6ICIjZmY0NDQ0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sOzxzdmcgeG1sbnM9XCJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z1wiIHZpZXdCb3g9XCIwIDAgNTEyIDUxMlwiPjxyZWN0IGZpbGw9XCIjZmY0NDQ0XCIgd2lkdGg9XCI1MTJcIiBoZWlnaHQ9XCI1MTJcIi8+PHRleHQgeD1cIjI1NlwiIHk9XCIyNzBcIiBmb250LXNpemU9XCIyNTZcIiBmaWxsPVwibm9uZVwiIHN0cm9rZT1cIiMwMDBcIiBzdHJva2Utd2lkdGg9XCI1MFwiPuivtTwvdGV4dD48L3N2Zz4iLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9Cg==">
    <style>
        /* ===== åŸºç¡€é‡ç½®ä¸è·¨å¹³å°é€‚é… ===== */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 100%);
            color: #fff;
            overflow: hidden;
            overscroll-behavior: none;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            touch-action: none;
        }

        /* æ”¯æŒæ·±è‰²æ¨¡å¼ */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #0a0a0a 0%, #1d1008 100%);
            }
        }

        /* ===== ä¸»å®¹å™¨ä¸å¸ƒå±€ç³»ç»Ÿ ===== */
        #container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* åŠ è½½ç”»é¢ - å¢å¼ºæ€§èƒ½ */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        #loadingScreen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #loadingText {
            font-size: clamp(20px, 5vw, 32px);
            color: #ff4444;
            margin-bottom: 30px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        .loadingBar {
            width: min(400px, 80vw);
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .loadingFill {
            height: 100%;
            background: linear-gradient(to right, #ff0000, #ff6666);
            width: 0%;
            animation: loading 2s ease-in-out infinite;
        }

        @keyframes loading {
            0% { width: 0%; }
            50% { width: 100%; }
            100% { width: 0%; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* ===== çŠ¶æ€æ  - å“åº”å¼è®¾è®¡ ===== */
        #statusBar {
            height: clamp(60px, 10vh, 80px);
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            border-bottom: 3px solid #8b0000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 clamp(10px, 2vw, 30px);
            flex-shrink: 0;
            position: relative;
        }

        #title {
            font-size: clamp(20px, 4vw, 32px);
            font-weight: bold;
            color: #ff4444;
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }

        #title:hover {
            text-shadow: 0 0 15px rgba(255, 68, 68, 0.8);
        }

        #devModeIndicator {
            position: absolute;
            top: 5px;
            left: 10px;
            background: #00ff00;
            color: #000;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            display: none;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .stats {
            display: flex;
            gap: clamp(10px, 2vw, 25px);
            flex-wrap: wrap;
        }

        .statItem {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .statLabel {
            font-size: clamp(10px, 2vw, 14px);
            color: #ccc;
            white-space: nowrap;
        }

        .statBar {
            width: clamp(60px, 15vw, 120px);
            height: 22px;
            background: #333;
            border: 2px solid #666;
            border-radius: 11px;
            overflow: hidden;
            position: relative;
        }

        .statFill {
            height: 100%;
            transition: width 0.4s ease;
            border-radius: 9px;
        }

        #healthFill { background: linear-gradient(to right, #ff0000, #ff6666); }
        #hungerFill { background: linear-gradient(to right, #ffa500, #ffcc66); }
        #sanityFill { background: linear-gradient(to right, #9370db, #dda0dd); }

        #timeDisplay {
            position: absolute;
            top: 90px;
            right: clamp(10px, 2vw, 30px);
            font-size: clamp(12px, 2vw, 18px);
            color: #ffaa00;
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #ffaa00;
            white-space: nowrap;
        }

        /* ===== ä¸‰æ¨¡å—ä¸»å†…å®¹åŒº - æ™ºèƒ½å¸ƒå±€ ===== */
        #mainContent {
            flex: 1;
            display: flex;
            min-height: 0;
            padding: clamp(8px, 1.5vw, 15px);
            gap: clamp(8px, 1.5vw, 15px);
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            #mainContent {
                flex-direction: column;
                padding: 5px;
                gap: 5px;
            }
            
            /* ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šå‚ç›´å †å ä¸‰ä¸ªæ¨¡å— */
            #storyModule { width: 100% !important; order: 1; }
            #choiceModule { width: 100% !important; order: 3; height: 200px; }
            #inventoryModule { width: 100% !important; order: 2; height: 150px; }
            
            .choiceBtn {
                min-height: 60px;
                font-size: 16px;
                padding: 15px;
            }
            
            .inventorySlot {
                font-size: 24px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            #mainContent {
                gap: 10px;
            }
            
            #choiceModule { width: 300px !important; }
            #inventoryModule { width: 250px !important; }
        }

        /* æ•…äº‹æ¨¡å— */
        #storyModule {
            flex: 1;
            background: rgba(0,0,0,0.8);
            border: 2px solid #444;
            border-radius: 15px;
            padding: clamp(15px, 2vw, 25px);
            display: flex;
            flex-direction: column;
            min-width: 0;
            backdrop-filter: blur(5px);
        }

        #storyTitle {
            font-size: clamp(20px, 3vw, 26px);
            color: #ff4444;
            margin-bottom: clamp(15px, 2vw, 20px);
            text-align: center;
            text-shadow: 0 0 8px rgba(255, 68, 68, 0.5);
            flex-shrink: 0;
        }

        #storyContent {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            -webkit-overflow-scrolling: touch; /* iOSæ»šåŠ¨ä¼˜åŒ– */
        }

        #storyContent::-webkit-scrollbar {
            width: 8px;
        }

        #storyContent::-webkit-scrollbar-track {
            background: #222;
            border-radius: 4px;
        }

        #storyContent::-webkit-scrollbar-thumb {
            background: #ff4444;
            border-radius: 4px;
        }

        .storyText {
            font-size: clamp(14px, 2vw, 18px);
            line-height: 1.8;
            color: #ddd;
            margin-bottom: 15px;
            opacity: 0;
            animation: fadeInUp 0.6s forwards;
            word-wrap: break-word;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dialogueBox {
            background: rgba(139, 0, 0, 0.2);
            border-left: 4px solid #ff4444;
            padding: clamp(10px, 1.5vw, 15px);
            margin: clamp(10px, 1.5vw, 15px) 0;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .speaker {
            font-size: clamp(12px, 1.8vw, 16px);
            color: #ff4444;
            font-weight: bold;
            margin-bottom: 8px;
        }

        /* é€‰æ‹©æ¨¡å— */
        #choiceModule {
            width: clamp(280px, 35vw, 380px);
            background: rgba(0,0,0,0.8);
            border: 2px solid #444;
            border-radius: 15px;
            padding: clamp(15px, 2vw, 25px);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            backdrop-filter: blur(5px);
        }

        #choiceTitle {
            font-size: clamp(18px, 2.5vw, 24px);
            color: #ffaa00;
            margin-bottom: clamp(15px, 2vw, 20px);
            text-align: center;
            flex-shrink: 0;
        }

        #choiceList {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: clamp(8px, 1.5vw, 15px);
            padding-right: 10px;
            -webkit-overflow-scrolling: touch;
        }

        #choiceList::-webkit-scrollbar {
            width: 8px;
        }

        .choiceBtn {
            padding: clamp(12px, 1.5vw, 20px);
            font-size: clamp(14px, 2vw, 18px);
            background: linear-gradient(135deg, #4d0000, #2a0000);
            border: 2px solid #ff4444;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
            overflow: hidden;
            min-height: clamp(50px, 8vh, 70px);
            display: flex;
            align-items: center;
            line-height: 1.4;
            user-select: none;
            -webkit-user-select: none;
        }

        .choiceBtn:hover {
            background: linear-gradient(135deg, #8b0000, #4d0000);
            transform: translateX(8px);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.4);
        }

        .choiceBtn:active {
            transform: translateX(4px) scale(0.98);
        }

        .choiceBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* èƒŒåŒ…æ¨¡å— */
        #inventoryModule {
            width: clamp(250px, 30vw, 340px);
            background: rgba(0,0,0,0.8);
            border: 2px solid #444;
            border-radius: 15px;
            padding: clamp(15px, 2vw, 25px);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            backdrop-filter: blur(5px);
        }

        #inventoryTitle {
            font-size: clamp(16px, 2.5vw, 24px);
            color: #44ff44;
            margin-bottom: clamp(15px, 2vw, 20px);
            text-align: center;
            flex-shrink: 0;
        }

        #inventoryGrid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: clamp(8px, 1.5vw, 12px);
            margin-bottom: clamp(15px, 2vw, 20px);
            flex-shrink: 0;
        }

        .inventorySlot {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.1);
            border: 2px solid #666;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: clamp(20px, 3vw, 32px);
            position: relative;
            touch-action: manipulation;
        }

        .inventorySlot:hover {
            border-color: #44ff44;
            background: rgba(68, 255, 68, 0.2);
            transform: scale(1.05);
        }

        .inventorySlot.hasItem {
            background: linear-gradient(135deg, #333, #555);
            border-color: #888;
        }

        .itemCount {
            position: absolute;
            bottom: 2px;
            right: 6px;
            font-size: clamp(10px, 1.5vw, 12px);
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 10px;
        }

        #inventoryInfo {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: clamp(10px, 1.5vw, 15px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #itemDetails {
            font-size: clamp(12px, 1.8vw, 16px);
            line-height: 1.6;
        }

        #itemName {
            font-size: clamp(14px, 2vw, 18px);
            color: #44ff44;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #itemDescription {
            color: #ccc;
            margin-bottom: 15px;
        }

        #useBtn {
            width: 100%;
            padding: clamp(10px, 1.5vw, 12px);
            font-size: clamp(14px, 2vw, 16px);
            background: linear-gradient(135deg, #44ff44, #228B22);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        #useBtn:hover {
            background: linear-gradient(135deg, #66ff66, #32cd32);
            transform: translateY(-2px);
        }

        #useBtn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* ===== å¼¹çª—ä¸æç¤ºç³»ç»Ÿ ===== */
        #warningModal {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(139, 0, 0, 0.95);
            border: 3px solid #ff0000;
            padding: clamp(15px, 2vw, 20px) clamp(25px, 3vw, 40px);
            border-radius: 10px;
            font-size: clamp(18px, 3vw, 24px);
            font-weight: bold;
            color: #ff4444;
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.8);
            display: none;
            z-index: 1000;
            animation: pulse 1s infinite;
            max-width: 90vw;
            text-align: center;
        }

        /* è°œé¢˜å¼¹çª— */
        #puzzleModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        #puzzleContent {
            background: rgba(20,20,20,0.98);
            border: 3px solid #ff4444;
            border-radius: 20px;
            padding: clamp(20px, 3vw, 40px);
            max-width: min(600px, 95vw);
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
        }

        #puzzleTitle {
            font-size: clamp(20px, 3vw, 28px);
            color: #ff4444;
            margin-bottom: clamp(15px, 2vw, 20px);
        }

        #codeInput {
            display: flex;
            gap: clamp(8px, 1.5vw, 15px);
            justify-content: center;
            margin: clamp(15px, 2vw, 30px) 0;
            flex-wrap: wrap;
        }

        .codeDigit {
            width: clamp(50px, 8vw, 70px);
            height: clamp(60px, 10vw, 90px);
            font-size: clamp(24px, 4vw, 42px);
            text-align: center;
            background: #333;
            border: 3px solid #666;
            border-radius: 10px;
            color: #fff;
        }

        .codeDigit:focus {
            border-color: #ff4444;
            outline: none;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
        }

        .puzzleBtn {
            padding: clamp(10px, 1.5vw, 12px) clamp(20px, 3vw, 30px);
            font-size: clamp(14px, 2vw, 18px);
            margin: 5px;
            background: linear-gradient(135deg, #8b0000, #4d0000);
            border: 2px solid #ff4444;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .puzzleBtn:hover {
            background: linear-gradient(135deg, #ff0000, #8b0000);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
        }

        /* æ¸¸æˆç»“æŸç”»é¢ */
        #gameOverScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.98);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }

        #gameOverContent {
            background: rgba(20,20,20,0.95);
            border: 3px solid #ff4444;
            border-radius: 20px;
            padding: clamp(20px, 3vw, 40px);
            text-align: center;
            max-width: min(700px, 95vw);
            max-height: 90vh;
            overflow-y: auto;
        }

        #gameOverTitle {
            font-size: clamp(32px, 5vw, 48px);
            margin-bottom: clamp(15px, 2vw, 20px);
            text-shadow: 0 0 20px currentColor;
        }

        #gameOverText {
            font-size: clamp(16px, 2vw, 20px);
            line-height: 1.6;
            margin-bottom: clamp(20px, 3vw, 30px);
            color: #ccc;
        }

        .restartBtn {
            padding: clamp(12px, 2vw, 15px) clamp(30px, 4vw, 40px);
            font-size: clamp(16px, 2.5vw, 20px);
            background: linear-gradient(135deg, #ff4444, #8b0000);
            border: 2px solid #ff6666;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            touch-action: manipulation;
        }

        .restartBtn:hover {
            background: linear-gradient(135deg, #ff6666, #ff0000);
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.7);
            transform: scale(1.05);
        }

        /* å¼€å‘è€…æ¨¡å¼å¼¹çª— */
        #devModeModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.98);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 20px;
        }

        #devModeContent {
            background: rgba(0,20,0,0.95);
            border: 3px solid #00ff00;
            border-radius: 20px;
            padding: clamp(20px, 3vw, 40px);
            max-width: min(800px, 95vw);
            max-height: 90vh;
            overflow-y: auto;
            color: #00ff00;
        }

        #devModeTitle {
            font-size: clamp(24px, 3.5vw, 32px);
            color: #00ff00;
            margin-bottom: clamp(20px, 3vw, 30px);
            text-align: center;
        }

        .devSection {
            margin-bottom: clamp(15px, 2vw, 25px);
            padding: clamp(10px, 1.5vw, 15px);
            background: rgba(0,255,0,0.1);
            border-radius: 10px;
            border: 1px solid #00ff00;
        }

        .devSectionTitle {
            font-size: clamp(16px, 2.5vw, 20px);
            margin-bottom: clamp(10px, 1.5vw, 15px);
        }

        .devControl {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: clamp(8px, 1vw, 10px) 0;
            flex-wrap: wrap;
        }

        .devLabel {
            width: min(100px, 20vw);
            font-size: clamp(12px, 1.5vw, 14px);
        }

        .devInput {
            flex: 1;
            min-width: 80px;
            padding: 8px;
            background: #222;
            border: 1px solid #00ff00;
            border-radius: 5px;
            color: #00ff00;
            font-size: 14px;
        }

        .devBtn {
            padding: 8px 15px;
            background: #00ff00;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
            touch-action: manipulation;
        }

        .devBtn:hover {
            background: #66ff66;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        /* å¯†ç è¾“å…¥å¼¹çª— */
        #passwordModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4500;
            padding: 20px;
        }

        #passwordContent {
            background: rgba(20,20,20,0.98);
            border: 3px solid #ffaa00;
            border-radius: 20px;
            padding: clamp(20px, 3vw, 40px);
            max-width: min(400px, 95vw);
            width: 100%;
        }

        #passwordTitle {
            font-size: clamp(20px, 3vw, 28px);
            color: #ffaa00;
            margin-bottom: clamp(15px, 2vw, 20px);
        }

        #passwordInput {
            width: 100%;
            padding: 15px;
            font-size: clamp(18px, 2.5vw, 24px);
            background: #333;
            border: 2px solid #666;
            border-radius: 10px;
            color: #fff;
            text-align: center;
            margin: clamp(15px, 2vw, 20px) 0;
        }

        .passwordBtn {
            padding: clamp(10px, 1.5vw, 12px) clamp(20px, 3vw, 30px);
            font-size: clamp(14px, 2vw, 18px);
            margin: 5px;
            touch-action: manipulation;
        }

        /* å‰§æƒ…æ¨è¿›æŒ‡ç¤ºå™¨ */
        #storyProgressIndicator {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: clamp(12px, 1.5vw, 14px);
            color: #888;
            font-style: italic;
            display: none;
            text-align: center;
        }

        /* æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘åŠ¨ç”» */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* é«˜DPIå±å¹•ä¼˜åŒ– */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            body {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }

        /* ===== è§¦æ‘¸åé¦ˆå¢å¼º ===== */
        .touch-feedback {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        /* é˜²æ­¢åŒå‡»ç¼©æ”¾ */
        @media screen and (max-width: 768px) {
            html {
                touch-action: manipulation;
            }
        }
    </style>
</head>
<body>
    <!-- åŠ è½½ç”»é¢ -->
    <div id="loadingScreen">
        <div id="loadingText">æ­£åœ¨åˆå§‹åŒ–æœ«æ—¥ä¸–ç•Œ...</div>
        <div class="loadingBar">
            <div class="loadingFill"></div>
        </div>
    </div>

    <!-- å¯†ç è¾“å…¥å¼¹çª— -->
    <div id="passwordModal">
        <div id="passwordContent">
            <h3 id="passwordTitle">ğŸ”“ å¼€å‘è€…æ¨¡å¼</h3>
            <p style="margin-bottom: 20px; color: #ccc;">è¯·è¾“å…¥å¼€å‘è€…å¯†ç ä»¥å¯ç”¨è°ƒè¯•åŠŸèƒ½</p>
            <input type="password" id="passwordInput" placeholder="è¾“å…¥å¯†ç " maxlength="10">
            <div style="margin-top: 20px;">
                <button class="passwordBtn" onclick="checkPassword()">ç¡®è®¤</button>
                <button class="passwordBtn" onclick="closePasswordModal()">å–æ¶ˆ</button>
            </div>
            <p id="passwordHint" style="margin-top: 15px; font-size: 14px; color: #ff4444;"></p>
        </div>
    </div>

    <!-- å¼€å‘è€…æ¨¡å¼æ§åˆ¶å° -->
    <div id="devModeModal">
        <div id="devModeContent">
            <h2 id="devModeTitle">ğŸ› ï¸ å¼€å‘è€…æ§åˆ¶å°</h2>
            
            <div class="devSection">
                <div class="devSectionTitle">çŠ¶æ€è°ƒæ•´</div>
                <div class="devControl">
                    <span class="devLabel">ç”Ÿå‘½å€¼:</span>
                    <input type="number" class="devInput" id="devHealth" min="0" max="100" value="100">
                    <button class="devBtn" onclick="devSetHealth()">è®¾ç½®</button>
                </div>
                <div class="devControl">
                    <span class="devLabel">é¥¥é¥¿å€¼:</span>
                    <input type="number" class="devInput" id="devHunger" min="0" max="100" value="80">
                    <button class="devBtn" onclick="devSetHunger()">è®¾ç½®</button>
                </div>
                <div class="devControl">
                    <span class="devLabel">ç†æ™ºå€¼:</span>
                    <input type="number" class="devInput" id="devSanity" min="0" max="100" value="90">
                    <button class="devBtn" onclick="devSetSanity()">è®¾ç½®</button>
                </div>
            </div>

            <div class="devSection">
                <div class="devSectionTitle">ç‰©å“ç®¡ç†</div>
                <div class="devControl">
                    <select class="devInput" id="devItemSelect">
                        <option value="">é€‰æ‹©ç‰©å“...</option>
                        <option value="key">ğŸ—ï¸ ç”Ÿé”ˆçš„é’¥åŒ™</option>
                        <option value="map">ğŸ—ºï¸ åŸå¸‚åœ°å›¾</option>
                        <option value="food">ğŸ¥« ç½å¤´é£Ÿå“</option>
                        <option value="medkit">ğŸ¥ åŒ»ç–—åŒ…</option>
                        <option value="ç¬”è®°">ğŸ““ ç ”ç©¶å‘˜ç¬”è®°</option>
                        <option value="antidote">ğŸ’‰ æŠ—ç—…æ¯’è¡€æ¸…</option>
                        <option value="radio">ğŸ“» æ”¶éŸ³æœº</option>
                        <option value="flashlight">ğŸ”¦ æ‰‹ç”µç­’</option>
                    </select>
                    <button class="devBtn" onclick="devAddItem()">æ·»åŠ </button>
                </div>
                <div class="devControl">
                    <button class="devBtn" style="width: 100%;" onclick="devClearInventory()">æ¸…ç©ºèƒŒåŒ…</button>
                </div>
            </div>

            <div class="devSection">
                <div class="devSectionTitle">åœºæ™¯è·³è½¬</div>
                <div class="devControl">
                    <select class="devInput" id="devSceneSelect">
                        <option value="shelter">ğŸ  é¿éš¾æ‰€</option>
                        <option value="ruins">ğŸšï¸ åŸå¸‚åºŸå¢Ÿ</option>
                        <option value="tunnel">ğŸš‡ åœ°é“éš§é“</option>
                        <option value="lab">ğŸ”¬ å®éªŒå®¤</option>
                    </select>
                    <button class="devBtn" onclick="devJumpScene()">è·³è½¬</button>
                </div>
            </div>

            <div class="devSection">
                <div class="devSectionTitle">æ ‡å¿—è®¾ç½®</div>
                <div class="devControl" style="flex-wrap: wrap; gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="devFlagKey" onchange="devSetFlag('hasKey', this.checked)">
                        <span style="font-size: 14px;">æœ‰é’¥åŒ™</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="devFlagMap" onchange="devSetFlag('hasMap', this.checked)">
                        <span style="font-size: 14px;">æœ‰åœ°å›¾</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="devFlagAntidote" onchange="devSetFlag('hasAntidote', this.checked)">
                        <span style="font-size: 14px;">æœ‰è¡€æ¸…</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="devFlagTruth" onchange="devSetFlag('knowsTruth', this.checked)">
                        <span style="font-size: 14px;">çŸ¥é“çœŸç›¸</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="devFlagDoor" onchange="devSetFlag('doorUnlocked', this.checked)">
                        <span style="font-size: 14px;">ä¿é™©ç®±å¼€å¯</span>
                    </label>
                </div>
            </div>

            <div class="devSection">
                <div class="devSectionTitle">å…¶ä»–</div>
                <div class="devControl">
                    <button class="devBtn" style="width: 100%; background: #ff4444;" onclick="devTriggerEnding()">ç«‹å³è§¦å‘ç»“å±€</button>
                </div>
                <div class="devControl">
                    <button class="devBtn" style="width: 100%;" onclick="devExportState()">å¯¼å‡ºçŠ¶æ€</button>
                </div>
            </div>

            <div class="devStatus" id="devStatus">
                ç­‰å¾…æ“ä½œ...
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="devBtn" style="background: #ff4444; color: #fff;" onclick="closeDevMode()">å…³é—­æ§åˆ¶å°</button>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div id="container" style="display: none;">
        <!-- çŠ¶æ€æ  -->
        <header id="statusBar">
            <div id="devModeIndicator">DEV MODE</div>
            <h1 id="title" onclick="attemptDevAccess()">ä¸§å°¸é€ƒç”Ÿ</h1>
            <div class="stats">
                <div class="statItem">
                    <span class="statLabel">ç”Ÿå‘½å€¼</span>
                    <div class="statBar">
                        <div id="healthFill" class="statFill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="statItem">
                    <span class="statLabel">é¥¥é¥¿å€¼</span>
                    <div class="statBar">
                        <div id="hungerFill" class="statFill" style="width: 80%"></div>
                    </div>
                </div>
                <div class="statItem">
                    <span class="statLabel">ç†æ™ºå€¼</span>
                    <div class="statBar">
                        <div id="sanityFill" class="statFill" style="width: 90%"></div>
                    </div>
                </div>
            </div>
            <div id="timeDisplay">ç¬¬1085å¤© 14:30</div>
        </header>

        <!-- ä¸‰æ¨¡å—ä¸»å†…å®¹åŒº -->
        <div id="mainContent">
            <!-- æ•…äº‹æ¨¡å— -->
            <div id="storyModule">
                <h2 id="storyTitle">åœ°ä¸‹é¿éš¾æ‰€</h2>
                <div id="storyContent"></div>
                <div id="storyProgressIndicator">ç­‰å¾…ç©å®¶é€‰æ‹©...</div>
            </div>

            <!-- é€‰æ‹©æ¨¡å— -->
            <div id="choiceModule">
                <h2 id="choiceTitle">è¡ŒåŠ¨é€‰æ‹©</h2>
                <div id="choiceList">ç­‰å¾…å‰§æƒ…åŠ è½½...</div>
            </div>

            <!-- èƒŒåŒ…æ¨¡å— -->
            <div id="inventoryModule">
                <h2 id="inventoryTitle">è£…å¤‡èƒŒåŒ…</h2>
                <div id="inventoryGrid"></div>
                <div id="inventoryInfo">
                    <div id="itemDetails">
                        <div id="itemName">é€‰æ‹©ç‰©å“æŸ¥çœ‹è¯¦æƒ…</div>
                        <div id="itemDescription">ç‚¹å‡»ä¸Šæ–¹ç‰©å“æˆ–ä½¿ç”¨ç‰©å“</div>
                        <button id="useBtn" disabled>ä½¿ç”¨ç‰©å“</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è­¦å‘Šæç¤º -->
        <div id="warningModal">âš ï¸ ä¸§å°¸æ¥è¿‘ä¸­ï¼</div>

        <!-- è°œé¢˜å¼¹çª— -->
        <div id="puzzleModal">
            <div id="puzzleContent">
                <h3 id="puzzleTitle">ä¿é™©ç®±å¯†ç </h3>
                <p style="margin-bottom: 20px; color: #ccc; font-size: 16px;">
                    æç¤ºï¼šé¿éš¾æ‰€å»ºé€ çš„æœˆä»½ + æœ«æ—¥çˆ†å‘çš„æ—¥æœŸ
                </p>
                <div id="codeInput">
                    <input type="text" class="codeDigit" maxlength="1" data-pos="0">
                    <input type="text" class="codeDigit" maxlength="1" data-pos="1">
                    <input type="text" class="codeDigit" maxlength="1" data-pos="2">
                    <input type="text" class="codeDigit" maxlength="1" data-pos="3">
                </div>
                <button class="puzzleBtn" onclick="checkPuzzleCode()">ç¡®è®¤</button>
                <button class="puzzleBtn" onclick="closePuzzle()">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- æ¸¸æˆç»“æŸç”»é¢ -->
        <div id="gameOverScreen">
            <div id="gameOverContent">
                <h1 id="gameOverTitle">ä»»åŠ¡å®Œæˆï¼</h1>
                <div id="gameOverText"></div>
                <button class="restartBtn" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
    </div>

    <script>
        // ===== æ¸¸æˆçŠ¶æ€ç®¡ç† - ä¼˜åŒ–å†…å­˜ä¸æ€§èƒ½ =====
        const gameState = {
            currentScene: 'shelter',
            currentTitle: 'åœ°ä¸‹é¿éš¾æ‰€',
            health: 100,
            hunger: 80,
            sanity: 90,
            inventory: {},
            storyProgress: 0,
            day: 1085,
            time: "14:30",
            flags: {
                hasKey: false,
                hasMap: false,
                hasAntidote: false,
                knowsTruth: false,
                doorUnlocked: false,
                flashlightFound: false,
                jackContacted: false,
                savedSurvivor: false,
                virusSample: false
            },
            puzzlesSolved: 0,
            devMode: false,
            storyQueue: [],
            isProcessing: false
        };

        // ç‰©å“æ•°æ®åº“ - è½»é‡çº§å®ç°
        const itemsDB = {
            key: { name: 'ç”Ÿé”ˆçš„é’¥åŒ™', icon: 'ğŸ—ï¸', description: 'ä¸€æŠŠé”ˆè¿¹æ–‘æ–‘çš„ä¿é™©ç®±é’¥åŒ™' },
            map: { name: 'åŸå¸‚åœ°å›¾', icon: 'ğŸ—ºï¸', description: 'æ ‡æ³¨äº†å®‰å…¨è·¯çº¿å’Œå®éªŒå®¤ä½ç½®çš„åœ°å›¾' },
            food: { name: 'ç½å¤´é£Ÿå“', icon: 'ğŸ¥«', description: 'æ¢å¤20ç‚¹é¥¥é¥¿å€¼ï¼Œä¿æŒä½“åŠ›' },
            medkit: { name: 'åŒ»ç–—åŒ…', icon: 'ğŸ¥', description: 'æ¢å¤30ç‚¹ç”Ÿå‘½å€¼ï¼Œæ²»ç–—ä¼¤åŠ¿' },
            ç¬”è®°: { name: 'ç ”ç©¶å‘˜ç¬”è®°', icon: 'ğŸ““', description: 'Anaçš„æ—¥è®°ï¼Œè®°è½½ç€ç—…æ¯’çˆ†å‘çš„çœŸç›¸' },
            antidote: { name: 'æŠ—ç—…æ¯’è¡€æ¸…', icon: 'ğŸ’‰', description: 'å¯ä»¥æ²»æ„ˆæ„ŸæŸ“çš„åŸå‹è¡€æ¸…' },
            radio: { name: 'å†›ç”¨å¯¹è®²æœº', icon: 'ğŸ“»', description: 'æ¥æ”¶åˆ°ç¥ç§˜ä¿¡å·å’Œåæ ‡' },
            flashlight: { name: 'æˆ˜æœ¯æ‰‹ç”µç­’', icon: 'ğŸ”¦', description: 'ç…§äº®é»‘æš—çš„å·¥å…·' },
            sample: { name: 'ç—…æ¯’æ ·æœ¬', icon: 'ğŸ§ª', description: 'ç”¨äºç ”ç©¶çš„åŸå§‹ç—…æ¯’æ ·æœ¬' }
        };

        // æ•…äº‹å†…å®¹ - æ‰©å±•å‰§æƒ…
        const storyContent = {
            shelter: {
                title: "åœ°ä¸‹é¿éš¾æ‰€",
                intro: [
                    "[ç³»ç»Ÿæ—¥å¿—] ç¬¬1085å¤©ï¼Œé¿éš¾æ‰€ç”µåŠ›ç³»ç»Ÿä¸ç¨³å®š...",
                    "ä½ åœ¨æ˜æš—çš„ç¯å…‰ä¸‹é†’æ¥ã€‚ä¸‰å¹´å‰ç—…æ¯’çˆ†å‘é‚£å¤©ï¼Œä½ æ­£åœ¨å»ºé€ è¿™ä¸ªåœ°ä¸‹é¿éš¾æ‰€ã€‚",
                    "å¯¹è®²æœºä¼ æ¥å¥³å£°ï¼š'è¿™é‡Œæ˜¯C-12å®‰å…¨åŒºï¼Œæˆ‘éœ€è¦æŠ—åŸä½“...'",
                    "ä½ å›ç­”ï¼š'æˆ‘è¿˜æ´»ç€ã€‚' å¥³å£°æ¿€åŠ¨é“ï¼š'æˆ‘æ˜¯Anaåšå£«ï¼Œæˆ‘ä»¬åœ¨å¯»æ‰¾è§£è¯ã€‚'",
                    "å¥¹å‘Šè¯‰ä½ å®éªŒå®¤æœ‰åŸå‹è¡€æ¸…ï¼Œä½†72å°æ—¶å†…å¿…é¡»åˆ°è¾¾ï¼Œç”µåŠ›å³å°†è€—å°½ã€‚",
                    "é¿éš¾æ‰€å¤–ä¼ æ¥æŠ“æŒ å£°...å®ƒä»¬æ‰¾åˆ°ä½ äº†ã€‚"
                ],
                choices: [
                    {
                        text: "æ£€æŸ¥é˜²å¾¡ç³»ç»Ÿ",
                        action: () => {
                            queueStory([
                                { text: "é’¢é“å¤§é—¨åšå›ºï¼Œä½†é—¨å¤–è‡³å°‘20åªä¸§å°¸ï¼é˜²å¾¡åªèƒ½åšæŒ48å°æ—¶ã€‚", speaker: "æ‰«æç»“æœ", type: "danger" },
                                { text: "Anaæ€¥é“ï¼š'å¿…é¡»ç«‹å³å‡ºå‘ï¼æˆ‘ä¼šå¼•å¯¼ä½ ã€‚'", speaker: "Ana", type: "info" }
                            ]);
                            updateStats(0, -5, -15);
                            gameState.flags.zombieOutside = true;
                        }
                    },
                    {
                        text: "ä¸Anaè§„åˆ’è·¯çº¿",
                        action: () => {
                            queueStory([
                                { text: "'å®éªŒå®¤åœ¨åœ°é“éš§é“å°½å¤´ã€‚' Anaè¯´ï¼Œ'ä½†ç–¯å­Jackåœ¨æ¸¸è¡ã€‚'", speaker: "Ana", type: "info" },
                                { text: "ç”·å£°æ’å…¥ï¼š'è°åœ¨è¯´æˆ‘ï¼Ÿæˆ‘åœ¨è¿™å¾…äº†ä¸‰å¹´ï¼Œæ²¡äººæ¯”æˆ‘æ›´æ‡‚åºŸå¢Ÿï¼'", speaker: "Jack", type: "warning" },
                                { text: "Anaè­¦å‘Šï¼š'å°å¿ƒJackï¼Œä»–ç²¾ç¥æœ‰é—®é¢˜...ä½†ä»–çŸ¥é“è¿‘è·¯ã€‚'", speaker: "Ana", type: "info" }
                            ]);
                            gameState.flags.jackContacted = true;
                            addInventoryItem('radio');
                        }
                    },
                    {
                        text: "æ‰“å¼€ä¿é™©ç®±ï¼ˆéœ€å¯†ç ï¼‰",
                        condition: () => !gameState.flags.doorUnlocked,
                        action: () => {
                            queueStory([
                                { text: "ç”µå­ä¿é™©ç®±æ—åˆ»ç€ï¼š'æœ«æ—¥é™ä¸´é‚£å¤©ï¼Œæˆ‘å¤±å»äº†ä¸€åˆ‡...'", speaker: "è§‚å¯Ÿ", type: "info" }
                            ]);
                            showPuzzle();
                        }
                    },
                    {
                        text: "é€ƒç¦»é¿éš¾æ‰€",
                        condition: () => gameState.flags.knowsTruth || gameState.flags.jackContacted || gameState.flags.doorUnlocked,
                        action: () => {
                            queueStory([
                                { text: "ä½ è£…å¤‡è¡¥ç»™ï¼Œæ‰“å¼€å¤§é—¨ã€‚å¤–é¢æ˜¯åºŸå¢ŸåŸå¸‚...", speaker: "ç³»ç»Ÿ", type: "warning" }
                            ]);
                            setTimeout(() => changeScene('ruins'), 4000);
                        }
                    }
                ]
            },
            ruins: {
                title: "åŸå¸‚åºŸå¢Ÿ",
                intro: [
                    "é˜³å…‰åˆºçœ¼ï¼Œä½ ç¬¬ä¸€æ¬¡å‘¼å¸åˆ°å¤–é¢çš„ç©ºæ°”ã€‚åºŸå¢Ÿå¦‚å·¨å¤§å°¸ä½“ã€‚",
                    "Anaé€šè¿‡å¯¹è®²æœºæŒ‡ç¤ºï¼š'å‘å·¦èµ°ï¼Œé¿å¼€å°¸ç¾¤ã€‚'",
                    "è¿œå¤„ä¼ æ¥æªå£°ï¼Œæ˜¯Jackåœ¨çŒæ€ä¸§å°¸ï¼Ÿè¿˜æ˜¯å…¶ä»–å¹¸å­˜è€…ï¼Ÿ"
                ],
                choices: [
                    {
                        text: "æ¢ç´¢åºŸå¼ƒè¶…å¸‚",
                        action: () => {
                            if (Math.random() > 0.4) {
                                queueStory([
                                    { text: "ä½ åœ¨åä»“å‘ç°Miaï¼å¥¹èº²åœ¨å†°æŸœé‡Œä¸‰å¤©äº†ã€‚", speaker: "å‘ç°", type: "success" },
                                    { text: "Miaè™šå¼±åœ°è¯´ï¼š'æˆ‘çŸ¥é“å®éªŒå®¤æš—é—¨å¯†ç ...0423...'", speaker: "Mia", type: "info" },
                                    { text: "Jackæ€’é“ï¼š'åˆ«å¸¦å¥¹ï¼å¯èƒ½è¢«å’¬äº†ï¼' Anaè¯´ï¼š'è¿™æœ‰é£é™©ï¼Œä½†æˆ‘ä»¬æ˜¯äººç±»...'", speaker: "ç³»ç»Ÿ", type: "warning" }
                                ]);
                                gameState.flags.survivorFound = true;
                            } else {
                                queueStory([
                                    { text: "è¶…å¸‚è¢«æ´—åŠ«ä¸€ç©ºã€‚çªç„¶è´§æ¶åä¼ æ¥ä½å¼å£°...", speaker: "å±é™©", type: "danger" },
                                    { text: "ä¸‰åªä¸§å°¸æ‰‘å‘ä½ ï¼ä¸€é¢—å­å¼¹ç²¾å‡†çˆ†å¤´ã€‚", speaker: "ç³»ç»Ÿ", type: "warning" },
                                    { text: "'æˆ‘å«Jackï¼Œä½ æ¬ æˆ‘ä¸€æ¡å‘½ã€‚' ç©¿è¿·å½©æœçš„ç”·äººå‡ºç°ã€‚", speaker: "Jack", type: "info" }
                                ]);
                                gameState.flags.jackMet = true;
                                updateStats(-5, -5, -5);
                            }
                        }
                    },
                    {
                        text: "æœå¯»å†›ç”¨è½¦",
                        action: () => {
                            if (!gameState.flags.hasMap && Math.random() > 0.5) {
                                queueStory([
                                    { text: "ä½ åœ¨æ‚é©¬é‡Œæ‰¾åˆ°åŸå¸‚åœ°å›¾å’Œæ‰‹ç”µï¼", speaker: "å‘ç°", type: "success" },
                                    { text: "Jackå‡ºç°ï¼š'é‚£æ˜¯æˆ‘çš„ã€‚æƒ³è¦ï¼Ÿæ‹¿é£Ÿç‰©æ¢ã€‚'", speaker: "Jack", type: "info" },
                                    { text: "Anaè­¦å‘Šï¼š'å¯èƒ½æ˜¯é™·é˜±ï¼Œä½†åˆ«æ¿€æ€’ä»–...'", speaker: "Ana", type: "warning" }
                                ]);
                                gameState.flags.hasMap = true;
                                addInventoryItem('map');
                                addInventoryItem('flashlight');
                            } else {
                                queueStory([
                                    { text: "è½¦è¾†è¢«ç‚¸ï¼Œåªå‰©æ®‹éª¸ã€‚ä»ªè¡¨ç›˜ä¸Šæœ‰Uç›˜...", speaker: "å‘ç°", type: "info" },
                                    { text: "Uç›˜é‡Œæœ‰å®éªŒå®¤åŸå§‹æ•°æ®ï¼Anaæ¿€åŠ¨ï¼š'èƒ½å¸®æˆ‘ä»¬æ”¹è¿›è¡€æ¸…ï¼'", speaker: "Ana", type: "success" },
                                    { text: "'æ•°æ®æ˜¯æˆ‘å®¶æ—çš„ã€‚' Jacké˜´æ£®åœ°è¯´ï¼Œ'ä½ æœ€å¥½æƒ³æ¸…æ¥šå†åŠ¨ã€‚' ä»–ä¸¾èµ·äº†æªã€‚", speaker: "Jack", type: "danger" }
                                ]);
                                gameState.flags.virusSample = true;
                                addInventoryItem('sample');
                            }
                        }
                    },
                    {
                        text: "æ•‘Miaå»å®‰å…¨ç‚¹",
                        condition: () => gameState.flags.survivorFound,
                        action: () => {
                            queueStory([
                                { text: "ä½ æ•‘Miaï¼Œç»™å¥¹é£Ÿç‰©ã€‚å¥¹è¯´ï¼š'å®éªŒå®¤æš—é—¨å¯†ç 0423ã€‚'", speaker: "Mia", type: "success" },
                                { text: "Jackæ„¤æ€’ï¼š'ä½ ä¼šåæ‚”çš„ï¼å¸¦ç€æ‹–æ²¹ç“¶æ´»ä¸è¿‡ä»Šæ™šï¼'", speaker: "Jack", type: "danger" },
                                { text: "Anaè¯´ï¼š'ä½ åšäº†æ­£ç¡®çš„äº‹ã€‚äººæ€§æ¯”ç”Ÿå­˜æ›´é‡è¦ã€‚'", speaker: "Ana", type: "info" }
                            ]);
                            gameState.flags.savedSurvivor = true;
                            updateStats(-10, -15, 10);
                            setTimeout(() => changeScene('tunnel'), 3000);
                        }
                    },
                    {
                        text: "ç‹¬è‡ªå‰å¾€éš§é“",
                        action: () => {
                            queueStory([
                                { text: "ä½ ç‹ ä¸‹å¿ƒç¦»å¼€ã€‚Miaç»æœ›çš„çœ¼ç¥éš¾å¿˜ï¼Œä½†å¿ƒè½¯å°±æ˜¯æ­»äº¡ã€‚", speaker: "å†…å¿ƒ", type: "warning" },
                                { text: "Jackè¯´ï¼š'æ˜æ™ºçš„é€‰æ‹©ã€‚æ„Ÿæƒ…ç”¨äº‹çš„äººæ´»ä¸é•¿ã€‚éš§é“åœ¨200ç±³å¤–ã€‚'", speaker: "Jack", type: "info" },
                                { text: "Anaæ²‰é»˜è‰¯ä¹…ï¼š'æˆ‘ç†è§£ï¼Œä½†è¿™ä»£ä»·å¤ªå¤§äº†ã€‚'", speaker: "Ana", type: "info" }
                            ]);
                            gameState.sanity -= 20;
                            setTimeout(() => changeScene('tunnel'), 3000);
                        }
                    }
                ]
            },
            tunnel: {
                title: "åºŸå¼ƒåœ°é“éš§é“",
                intro: [
                    "é»‘æš—åå™¬ä¸€åˆ‡ã€‚åªæœ‰æ‰‹ç”µèƒ½ç…§äº®ä¸‰ç±³ã€‚",
                    "å¢™ä¸Šæ»¡æ˜¯è¡€æ‰‹å°ã€‚è¿™é‡Œæ›¾æ˜¯ä¸§å°¸å·¢ç©´ã€‚",
                    "Jackè¯´ï¼š'å°å¿ƒï¼Œè¿™é‡Œæœ‰æˆ‘ä¸‰å¹´å‰è®¾çš„é™·é˜±ã€‚'"
                ],
                choices: [
                    {
                        text: "ç”¨æ‰‹ç”µç­’å‰è¿›",
                        condition: () => hasItem('flashlight'),
                        action: () => {
                            queueStory([
                                { text: "æ‰‹ç”µç…§äº®å‰æ–¹ï¼š'å®éªŒå®¤â†’200m'ã€‚", speaker: "å‘ç°", type: "info" },
                                { text: "åœ°é¢å¡Œé™·ï¼ä½ æ‰è¿›åœ°ä¸‹ç©ºé—´...", speaker: "å±é™©", type: "danger" },
                                { text: "'æ¬¢è¿æ¥åˆ°æˆ‘å®¶ã€‚' Jackè¯´ï¼Œ'æƒ³è¦è¡€æ¸…ï¼Ÿæ‹¿æ ·æœ¬æ¢ã€‚'", speaker: "Jack", type: "warning" }
                            ]);
                            if (gameState.flags.virusSample) {
                                queueStory([
                                    { text: "ä½ æ‹¿å‡ºUç›˜ï¼š'æ•°æ®åœ¨è¿™ï¼Œæ”¾æˆ‘ä¸Šå»ï¼'", speaker: "ä½ ", type: "info" },
                                    { text: "Jackå¤§ç¬‘ï¼š'èªæ˜ã€‚serumåœ¨å®éªŒå®¤ï¼Œä½†é‚£é‡Œæœ‰æ›´å¤§ç§˜å¯†...'", speaker: "Jack", type: "info" },
                                    { text: "Anaç´§æ€¥ï¼š'åˆ«ä¿¡ï¼çœŸæ­£çš„å®éªŒå®¤åœ¨æ›´æ·±å¤„ï¼'", speaker: "Ana", type: "danger" }
                                ]);
                            }
                        }
                    },
                    {
                        text: "æ£€æŸ¥å¢™ä¸Šæ¶‚é¸¦",
                        action: () => {
                            queueStory([
                                { text: "æ¶‚é¸¦ï¼š'å®éªŒå®¤ä¸æ˜¯æ•‘äººçš„åœ°æ–¹ï¼Œæ˜¯åœ°ç‹±ã€‚â€”â€”Dr.Ana'", speaker: "æ¶‚é¸¦", type: "info" },
                                { text: "Anaæ²‰é»˜ï¼š'...é‚£æ˜¯æˆ‘å†™çš„ã€‚æˆ‘ä»¥ä¸ºåˆ›é€ äº†å¸Œæœ›ï¼Œå…¶å®æ˜¯æ‰“å¼€äº†æ½˜å¤šæ‹‰é­”ç›’ã€‚'", speaker: "Ana", type: "warning" },
                                { text: "'æ‰€ä»¥è¡€æ¸…æ˜¯è°è¨€ï¼Ÿ'ä½ è´¨é—®ã€‚Anaç­”ï¼š'è¡€æ¸…å­˜åœ¨ï¼Œä½†ä»£ä»·æ˜¯...éœ€è¦æ´»äººåšè½½ä½“ã€‚'", speaker: "ç³»ç»Ÿ", type: "danger" }
                            ]);
                            gameState.flags.knowsTruth = true;
                        }
                    },
                    {
                        text: "ç”¨æš—é—¨ï¼ˆMiaæç¤ºï¼‰",
                        condition: () => gameState.flags.savedSurvivor,
                        action: () => {
                            queueStory([
                                { text: "ä½ è¾“å…¥0423ï¼Œå¢™å£æ‰“å¼€ï¼ç§˜å¯†é€šé“...", speaker: "æˆåŠŸ", type: "success" },
                                { text: "Miaè¯´ï¼š'é‚£æ˜¯æˆ‘çˆ¶äº²è®¾è®¡çš„é€ƒç”Ÿé€šé“ï¼Œä»–æ˜¯é¦–å¸­å·¥ç¨‹å¸ˆã€‚'", speaker: "Mia", type: "info" },
                                { text: "é€šé“ç›´é€šå®éªŒå®¤æ ¸å¿ƒï¼ä½†Anaè¯´ï¼š'é‚£é‡Œæœ‰æˆ‘ç•™ä¸‹çš„ä¸œè¥¿...'", speaker: "Ana", type: "warning" }
                            ]);
                            setTimeout(() => changeScene('lab'), 3000);
                        }
                    },
                    {
                        text: "ç¡¬é—¯åˆ°å®éªŒå®¤",
                        action: () => {
                            queueStory([
                                { text: "ä½ ç¡¬é—¯ã€‚Jackçš„é™·é˜±è§¦å‘è­¦æŠ¥ï¼Œå°¸ç¾¤æ¶Œæ¥...", speaker: "å±é™©", type: "danger" },
                                { text: "Anaè¿œç¨‹æ‰“å¼€åº”æ€¥é—¨ï¼š'å¿«è·‘ï¼æˆ‘é»‘å…¥äº†ç³»ç»Ÿï¼'", speaker: "Ana", type: "success" },
                                { text: "ä½ å†²è¿›å®éªŒå®¤ï¼ŒJackå°¾éšï¼š'æ¸¸æˆç»“æŸï¼Œç§‘å­¦å®¶ã€‚è¡€æ¸…å½’æˆ‘ã€‚'", speaker: "Jack", type: "danger" }
                            ]);
                            showWarning("âš ï¸ å°¸ç¾¤è¢­æ¥ï¼");
                            updateStats(-25, -10, -20);
                            setTimeout(() => changeScene('lab'), 2000);
                        }
                    }
                ]
            },
            lab: {
                title: "ç¥ç§˜å®éªŒå®¤",
                intro: [
                    "å®éªŒå®¤æ ¸å¿ƒã€‚åŸ¹å…»ä»“ç ´è£‚ï¼Œæ»¡åœ°å®éªŒè®°å½•ã€‚",
                    "Anaé¢¤æŠ–ï¼š'æˆ‘åˆ›é€ äº†è§£è¯ï¼Œä¹Ÿåˆ›é€ äº†æ€ªç‰©ã€‚ç—…æ¯’æ˜¯æˆ‘ç ”å‘çš„ç”Ÿç‰©æ­¦å™¨...'",
                    "Jackä¸¾æªå¯¹å‡†ä½ ï¼š'åšä¸ªé€‰æ‹©ã€‚æŠŠè¡€æ¸…ç»™æˆ‘ï¼Œæˆ–è€…æˆ‘é€ä½ å»è§é‚£äº›è¢«ä½ å®³æ­»çš„çµé­‚ã€‚'"
                ],
                choices: [
                    {
                        text: "é˜…è¯»Anaçš„æ—¥å¿—",
                        action: () => {
                            queueStory([
                                { text: "æ—¥å¿—ï¼š'ç¬¬1079å¤©ï¼Œæˆ‘åˆæˆäº†è¡€æ¸…ã€‚ä½†éœ€è¦æ´»äººæŠ—ä½“ã€‚æˆ‘è‡ªæ„¿æˆä¸ºå®éªŒä½“ã€‚'", speaker: "Anaçš„æ—¥å¿—", type: "info" },
                                { text: "'ä½†ç—…æ¯’å˜å¼‚äº†ï¼Œè¡€æ¸…åªèƒ½æ•‘å°‘æ•°äººã€‚æˆ‘é€‰æ‹©äº†æ”¾å¼ƒ...'", speaker: "æ—¥å¿—", type: "danger" },
                                { text: "Anaå“­æ³£ï¼š'æˆ‘é”™äº†...ç›´åˆ°å¬åˆ°ä½ çš„å£°éŸ³ï¼Œæˆ‘æ‰æ˜ç™½å¸Œæœ›ä¸æ˜¯æ•°æ®ï¼Œæ˜¯äººæ€§ã€‚'", speaker: "Ana", type: "warning" }
                            ]);
                        }
                    },
                    {
                        text: "ä¸Jackå¯¹å³™ï¼ˆé“å¾·æŠ‰æ‹©ï¼‰",
                        action: () => {
                            if (gameState.flags.savedSurvivor) {
                                queueStory([
                                    { text: "Miaå†²è¿›æ¥ï¼š'Jackï¼Œä½ è¿˜è®°å¾—æˆ‘çˆ¶äº²çš„æ‰¿è¯ºå—ï¼Ÿä½ ä¼šä¿æŠ¤æˆ‘ä»¬ï¼'", speaker: "Mia", type: "info" },
                                    { text: "Jackçš„æ‰‹é¢¤æŠ–...ä»–æ”¾ä¸‹æªï¼š'...æˆ‘è¿™å°±å¸¦ä½ ä»¬å»å®‰å…¨åŒºã€‚è¡€æ¸…...æˆ‘ä»¬å¹³åˆ†ã€‚'", speaker: "Jack", type: "success" }
                                ]);
                            } else {
                                queueStory([
                                    { text: "Jackå†·ç¬‘ï¼š'æ²¡æœ‰ç´¯èµ˜ï¼Œæˆ‘ä»¬å¯ä»¥ç»Ÿæ²»åºŸåœŸï¼è¡€æ¸…ç»™æˆ‘ï¼Œæˆ–è€…ä½ æ­»ã€‚'", speaker: "Jack", type: "danger" },
                                    { text: "ä½ é¢ä¸´æŠ‰æ‹©ï¼šä¿¡ä»»ç–¯å­ï¼Œè¿˜æ˜¯ç‹¬è‡ªé€ƒç¦»ï¼Ÿ", speaker: "ç³»ç»Ÿ", type: "warning" }
                                ]);
                            }
                        }
                    },
                    {
                        text: "æ³¨å°„è¡€æ¸…ï¼ˆéœ€ä¿¡ä»»Anaï¼‰",
                        condition: () => gameState.flags.knowsTruth && gameState.flags.hasAntidote,
                        action: () => {
                            queueStory([
                                { text: "ä½ æ‹¿èµ·è¡€æ¸…ã€‚Anaè¯´ï¼š'ç­‰ç­‰ï¼éœ€è¦é…åˆç—…æ¯’æ ·æœ¬æ¿€æ´»...å¿«æ’å…¥Uç›˜ï¼'", speaker: "Ana", type: "info" },
                                { text: "ä½ ç…§åšã€‚åŸ¹å…»ä»“äº®èµ·ç»¿ç¯ï¼Œè¡€æ¸…å¼€å§‹å¤åˆ¶ï¼æˆåŠŸäº†ï¼", speaker: "ç³»ç»Ÿ", type: "success" },
                                { text: "Jackéœ‡æƒŠï¼š'ä½ ...çœŸçš„åšåˆ°äº†ï¼Ÿæˆ‘é”™äº†ã€‚' ä»–è·ªä¸‹äº†ã€‚", speaker: "Jack", type: "info" }
                            ]);
                            setTimeout(() => triggerEnding(), 3000);
                        }
                    },
                    {
                        text: "ç‹¬è‡ªé€ƒç¦»",
                        action: () => {
                            queueStory([
                                { text: "ä½ å¸¦ç€è¡€æ¸…å†²å‡ºå®éªŒå®¤ï¼Œèº«åä¼ æ¥æªå£°å’Œæƒ¨å«...ä½ é€ƒäº†ã€‚", speaker: "ç³»ç»Ÿ", type: "info" },
                                { text: "ä½†æœ€ç»ˆï¼Œä½ åªèƒ½æ•‘è‡ªå·±ã€‚è¡€æ¸…æœ‰é™ï¼Œäººæ€§åœ¨æœ«æ—¥é‡Œå¤ªå¥¢ä¾ˆ...", speaker: "ç»“å±€", type: "warning" }
                            ]);
                            setTimeout(() => triggerEnding(), 2000);
                        }
                    }
                ]
            }
        };

        // ===== æ ¸å¿ƒç³»ç»Ÿ =====

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // åˆå§‹åŒ–èƒŒåŒ…æ ¼å­
            const inventoryGrid = document.getElementById('inventoryGrid');
            for (let i = 0; i < 16; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventorySlot';
                slot.dataset.index = i;
                slot.addEventListener('click', () => selectInventoryItem(slot));
                // è§¦æ‘¸åé¦ˆ
                slot.addEventListener('touchstart', createTouchFeedback, { passive: true });
                inventoryGrid.appendChild(slot);
            }

            // éšè—åŠ è½½ç”»é¢
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.classList.add('hidden');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    document.getElementById('container').style.display = 'flex';
                }, 500);
                startStory();
            }, 2500);
        }

        // è§¦æ‘¸åé¦ˆæ•ˆæœ
        function createTouchFeedback(e) {
            const touch = e.touches[0];
            const ripple = document.createElement('div');
            ripple.className = 'touch-feedback';
            ripple.style.left = (touch.clientX - 10) + 'px';
            ripple.style.top = (touch.clientY - 10) + 'px';
            ripple.style.width = '20px';
            ripple.style.height = '20px';
            document.body.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        // æ•…äº‹é˜Ÿåˆ—ç³»ç»Ÿ
        function queueStory(storyItems) {
            gameState.storyQueue = storyItems;
            gameState.isProcessing = true;
            document.getElementById('choiceList').style.display = 'none';
            updateProgressIndicator(true);
            
            processStoryQueue();
        }

        function processStoryQueue() {
            if (gameState.storyQueue.length === 0) {
                gameState.isProcessing = false;
                document.getElementById('choiceList').style.display = 'flex';
                updateProgressIndicator(false);
                setTimeout(() => continueAfterChoice(), 500);
                return;
            }
            
            const nextItem = gameState.storyQueue.shift();
            addStoryText(nextItem.text, nextItem.speaker, nextItem.type);
            
            if (nextItem.effect) {
                nextItem.effect();
            }
            
            setTimeout(processStoryQueue, 3000);
        }

        // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
        function updateProgressIndicator(show) {
            const indicator = document.getElementById('storyProgressIndicator');
            if (show) {
                indicator.textContent = "ğŸ“– å‰§æƒ…æ’­æ”¾ä¸­...";
                indicator.style.display = 'block';
            } else {
                indicator.textContent = "âœ… è¯·ç»§ç»­é€‰æ‹©...";
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 3000);
            }
        }

        // é€‰æ‹©åç»§ç»­å‰§æƒ…
        function continueAfterChoice() {
            updateChoices(gameState.currentScene);
        }

        // å¼€å§‹æ•…äº‹
        function startStory() {
            const introTexts = storyContent.shelter.intro;
            let index = 0;
            
            const showNext = () => {
                if (index < introTexts.length) {
                    addStoryText(introTexts[index], "åºç« ", "info");
                    index++;
                    setTimeout(showNext, 4000);
                } else {
                    updateChoices('shelter');
                }
            };
            
            showNext();
        }

        // æ·»åŠ æ•…äº‹æ–‡æœ¬
        function addStoryText(text, speaker = "", type = "info") {
            const storyContent = document.getElementById('storyContent');
            const storyBox = document.createElement('div');
            storyBox.className = 'dialogueBox';
            
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker';
            
            // è§’è‰²é¢œè‰²åŒºåˆ†
            const speakerColors = {
                'Ana': '#ff44ff',
                'Jack': '#44aaff',
                'Mia': '#88ff88',
                'ç³»ç»Ÿ': '#ffaa44'
            };
            
            speakerDiv.textContent = speaker;
            if (speakerColors[speaker]) {
                speakerDiv.style.color = speakerColors[speaker];
            }
            
            const textDiv = document.createElement('div');
            textDiv.className = 'storyText';
            textDiv.textContent = text;
            
            storyBox.appendChild(speakerDiv);
            storyBox.appendChild(textDiv);
            storyContent.appendChild(storyBox);
            
            // è‡ªåŠ¨æ»šåŠ¨
            storyContent.scrollTop = storyContent.scrollHeight;
            
            // è§†è§‰åŒºåˆ†
            if (type === "warning" || type === "danger") {
                storyBox.style.borderLeftColor = "#ff0000";
                storyBox.style.background = "rgba(139, 0, 0, 0.3)";
                storyBox.style.boxShadow = "0 0 15px rgba(255, 0, 0, 0.2)";
            } else if (type === "success") {
                storyBox.style.borderLeftColor = "#44ff44";
                storyBox.style.background = "rgba(68, 139, 0, 0.3)";
                storyBox.style.boxShadow = "0 0 15px rgba(68, 255, 68, 0.2)";
            }
        }

        // æ›´æ–°é€‰æ‹©æŒ‰é’®
        function updateChoices(sceneName) {
            if (gameState.isProcessing) return;
            
            const choiceList = document.getElementById('choiceList');
            choiceList.innerHTML = '';
            
            if (!storyContent[sceneName] || !storyContent[sceneName].choices) return;
            
            storyContent[sceneName].choices.forEach(choice => {
                if (choice.condition && !choice.condition()) return;
                
                const btn = document.createElement('button');
                btn.className = 'choiceBtn';
                btn.textContent = choice.text;
                btn.addEventListener('click', () => {
                    if (gameState.isProcessing) return;
                    document.getElementById('storyProgressIndicator').style.display = 'none';
                    choice.action();
                });
                // è§¦æ‘¸åé¦ˆ
                btn.addEventListener('touchstart', createTouchFeedback, { passive: true });
                choiceList.appendChild(btn);
            });
            
            if (choiceList.children.length === 0) {
                choiceList.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">å½“å‰æ— å¯ç”¨è¡ŒåŠ¨</div>';
            }
        }

        // åˆ‡æ¢åœºæ™¯
        function changeScene(sceneName) {
            if (gameState.isProcessing) {
                setTimeout(() => changeScene(sceneName), 1000);
                return;
            }
            
            gameState.currentScene = sceneName;
            gameState.currentTitle = storyContent[sceneName].title;
            
            document.getElementById('storyContent').innerHTML = '';
            document.getElementById('storyTitle').textContent = gameState.currentTitle;
            
            const introTexts = storyContent[sceneName].intro;
            let index = 0;
            
            const showNext = () => {
                if (index < introTexts.length) {
                    addStoryText(introTexts[index], "åœºæ™¯", "info");
                    index++;
                    setTimeout(showNext, 3500);
                } else {
                    updateChoices(sceneName);
                }
            };
            
            showNext();
        }

        // èƒŒåŒ…ç®¡ç†
        function addInventoryItem(itemKey) {
            if (!itemsDB[itemKey]) return;
            
            const item = itemsDB[itemKey];
            
            if (gameState.inventory[itemKey]) {
                gameState.inventory[itemKey].count++;
            } else {
                gameState.inventory[itemKey] = { ...item, count: 1 };
            }
            
            updateInventoryUI();
            addStoryText(`è·å¾—äº†ï¼š${item.name}`, "ç³»ç»Ÿ", "success");
        }

        function hasItem(itemKey) {
            return gameState.inventory[itemKey] && gameState.inventory[itemKey].count > 0;
        }

        function removeInventoryItem(itemKey) {
            if (gameState.inventory[itemKey]) {
                gameState.inventory[itemKey].count--;
                if (gameState.inventory[itemKey].count <= 0) {
                    delete gameState.inventory[itemKey];
                }
                updateInventoryUI();
            }
        }

        function updateInventoryUI() {
            const slots = document.querySelectorAll('.inventorySlot');
            
            slots.forEach(slot => {
                slot.classList.remove('hasItem');
                slot.textContent = '';
                slot.innerHTML = '';
                slot.dataset.item = '';
            });
            
            const itemKeys = Object.keys(gameState.inventory);
            itemKeys.forEach((itemKey, index) => {
                if (index >= slots.length) return;
                
                const item = gameState.inventory[itemKey];
                const slot = slots[index];
                
                slot.classList.add('hasItem');
                slot.textContent = item.icon;
                slot.dataset.item = itemKey;
                
                if (item.count > 1) {
                    const countBadge = document.createElement('div');
                    countBadge.className = 'itemCount';
                    countBadge.textContent = item.count;
                    slot.appendChild(countBadge);
                }
            });
        }

        function selectInventoryItem(slot) {
            const itemKey = slot.dataset.item;
            if (!itemKey || !gameState.inventory[itemKey]) return;
            
            const item = gameState.inventory[itemKey];
            document.getElementById('itemName').textContent = item.name;
            document.getElementById('itemDescription').textContent = item.description;
            
            const useBtn = document.getElementById('useBtn');
            useBtn.disabled = false;
            useBtn.onclick = () => useSelectedItem(itemKey);
            
            document.querySelectorAll('.inventorySlot').forEach(s => s.style.borderColor = '#666');
            slot.style.borderColor = '#44ff44';
        }

        function useSelectedItem(itemKey) {
            const item = gameState.inventory[itemKey];
            
            const effects = {
                food: () => { updateStats(0, 20, 0); addStoryText("ä½ åƒæ‰äº†ç½å¤´é£Ÿå“ï¼Œé¥¥é¥¿æ„Ÿå‡è½»äº†ã€‚", "ç³»ç»Ÿ", "success"); },
                medkit: () => { updateStats(30, 0, 0); addStoryText("ä½ ä½¿ç”¨äº†åŒ»ç–—åŒ…ï¼Œä¼¤åŠ¿æ˜æ˜¾å¥½è½¬ã€‚", "ç³»ç»Ÿ", "success"); },
                flashlight: () => { updateStats(0, 0, 10); addStoryText("æ‰‹ç”µç­’ç…§äº®äº†å‘¨å›´ï¼Œå®‰å¿ƒäº†ä¸€äº›ã€‚", "ç³»ç»Ÿ", "info"); },
                ç¬”è®°: () => { addStoryText("ç¬”è®°è®°è½½ç—…æ¯’çœŸç›¸ï¼šå†›æ–¹ç”Ÿç‰©æ­¦å™¨å®éªŒã€‚", "ç¬”è®°", "info"); gameState.flags.knowsTruth = true; }
            };
            
            if (effects[itemKey]) {
                effects[itemKey]();
                if (itemKey !== 'flashlight' && itemKey !== 'ç¬”è®°') {
                    removeInventoryItem(itemKey);
                }
            }
            
            document.getElementById('itemName').textContent = 'é€‰æ‹©ç‰©å“æŸ¥çœ‹è¯¦æƒ…';
            document.getElementById('itemDescription').textContent = 'ç‚¹å‡»ä¸Šæ–¹ç‰©å“æˆ–ä½¿ç”¨ç‰©å“';
            document.getElementById('useBtn').disabled = true;
            document.querySelectorAll('.inventorySlot').forEach(s => s.style.borderColor = '#666');
        }

        // æ›´æ–°çŠ¶æ€
        function updateStats(healthChange = 0, hungerChange = 0, sanityChange = 0) {
            gameState.health = Math.max(0, Math.min(100, gameState.health + healthChange));
            gameState.hunger = Math.max(0, Math.min(100, gameState.hunger + hungerChange));
            gameState.sanity = Math.max(0, Math.min(100, gameState.sanity + sanityChange));
            
            document.getElementById('healthFill').style.width = gameState.health + '%';
            document.getElementById('hungerFill').style.width = gameState.hunger + '%';
            document.getElementById('sanityFill').style.width = gameState.sanity + '%';
            
            if (gameState.health <= 0) {
                gameOver(false, "ä½ åœ¨æœ«æ—¥ä¸­é™¨è½äº†...");
            } else if (gameState.sanity <= 0) {
                gameOver(false, "ç†æ™ºå´©æºƒï¼Œæ— æ³•åˆ†æ¸…ç°å®ä¸å¹»è§‰...");
            }
        }

        // æ˜¾ç¤ºè­¦å‘Š
        function showWarning(message) {
            const warning = document.getElementById('warningModal');
            warning.textContent = message;
            warning.style.display = 'block';
            setTimeout(() => warning.style.display = 'none', 3000);
        }

        // è°œé¢˜ç³»ç»Ÿ
        function showPuzzle() {
            document.getElementById('puzzleModal').style.display = 'flex';
            const inputs = document.querySelectorAll('.codeDigit');
            inputs.forEach(input => input.value = '');
            inputs[0].focus();
            
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value && index < 3) {
                        inputs[index + 1].focus();
                    }
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
                // è§¦æ‘¸åé¦ˆ
                input.addEventListener('touchstart', createTouchFeedback, { passive: true });
            });
        }

        function closePuzzle() {
            document.getElementById('puzzleModal').style.display = 'none';
            setTimeout(() => continueAfterChoice(), 500);
        }

        function checkPuzzleCode() {
            const digits = Array.from(document.querySelectorAll('.codeDigit'));
            const code = digits.map(input => input.value).join('');
            
            if (code === '0423') {
                gameState.flags.doorUnlocked = true;
                gameState.puzzlesSolved++;
                queueStory([
                    { text: "ä¿é™©ç®±æ‰“å¼€ï¼é‡Œé¢æœ‰æ‰‹ç”µã€é£Ÿç‰©å’ŒAnaçš„æ—¥è®°ï¼", speaker: "æˆåŠŸ", type: "success" }
                ]);
                addInventoryItem('flashlight');
                addInventoryItem('food');
                updateStats(0, 10, 10);
                closePuzzle();
                return true;
            } else {
                queueStory([
                    { text: "å¯†ç é”™è¯¯ï¼è­¦æŠ¥å£°å“èµ·ï¼", speaker: "é”™è¯¯", type: "danger" }
                ]);
                digits.forEach(input => {
                    input.value = '';
                    input.style.borderColor = '#ff0000';
                    setTimeout(() => input.style.borderColor = '#666', 500);
                });
                inputs[0].focus();
                updateStats(0, 0, -10);
                return false;
            }
        }

        // è§¦å‘ç»“å±€
        function triggerEnding() {
            setTimeout(() => {
                const hasAntidote = gameState.flags.hasAntidote;
                const knowsTruth = gameState.flags.knowsTruth;
                const savedSurvivor = gameState.flags.savedSurvivor;
                const health = gameState.health;
                const puzzlesSolved = gameState.puzzlesSolved;
                
                // å®Œç¾äººé“ä¸»ä¹‰ç»“å±€
                if (hasAntidote && savedSurvivor && puzzlesSolved >= 1 && health > 60) {
                    gameOver(true, 
                        "ä½ æ•‘Miaï¼Œå¸¦è¡€æ¸…å›åˆ°å®‰å…¨åŒºã€‚Anaç”¨æ•°æ®æ”¹è¿›è¡€æ¸…ï¼Œå¯ä»¥å¤§è§„æ¨¡ç”Ÿäº§ã€‚\n\n" +
                        "ä½ è¯æ˜äº†æœ«æ—¥ä¸­äººæ€§ä¸ç­ã€‚Miaæˆä¸ºç ”ç©¶å‘˜ï¼ŒJackåŠ å…¥é˜²å¾¡é˜Ÿã€‚\n\n" +
                        "ã€å®Œç¾äººé“ç»“å±€ã€‘\nè§£è°œ: 1/1 | æ•‘äºº: âœ“ | è¡€æ¸…: âœ“ | çœŸç›¸: âœ“"
                    );
                }
                // çœŸç›¸ç»“å±€
                else if (hasAntidote && knowsTruth && puzzlesSolved >= 1) {
                    gameOver(true,
                        "ä½ æ­éœ²å†›æ–¹å®éªŒçœŸç›¸ï¼Œå¸¦æ”¹è‰¯è¡€æ¸…å›å®‰å…¨åŒºã€‚Anaå…¬å¼€æ•°æ®ï¼Œä¸–ç•Œé‡å»ºã€‚\n\n" +
                        "è™½ç„¶ä»£ä»·æƒ¨é‡ï¼Œä½†äººç±»ä»é”™è¯¯ä¸­å­¦ä¹ ã€‚ä½ æˆä¸ºæ–°ä¸–ç•Œçš„è§è¯äººã€‚\n\n" +
                        "ã€çœŸç›¸ç»“å±€ã€‘\nè§£è°œ: 1/1 | è¡€æ¸…: âœ“ | çœŸç›¸: âœ“ | é“å¾·: å¹¸å­˜"
                    );
                }
                // ç”Ÿå­˜ç»“å±€
                else if (hasAntidote && health > 50) {
                    gameOver(true,
                        "ä½ åˆ°è¾¾å®‰å…¨åŒºï¼Œè™½æ”¾å¼ƒMiaå’ŒçœŸç›¸ï¼Œä½†è‡³å°‘ä¸ºäººç±»å¸¦å›æŠ—åŸä½“ã€‚\n\n" +
                        "ä½ æ´»äº†ä¸‹æ¥ï¼Œä½†å†…å¿ƒæ°¸è¿œæ— æ³•å¹³é™ã€‚åœ¨æœ«æ—¥ï¼Œç”Ÿå­˜æœ¬èº«å°±æ²‰é‡ã€‚\n\n" +
                        "ã€ç”Ÿå­˜ç»“å±€ã€‘\nè§£è°œ: 0/1 | æ•‘äºº: âœ— | è¡€æ¸…: âœ“ | ä»£ä»·: äººæ€§"
                    );
                }
                // é—æ†¾ç»“å±€
                else {
                    gameOver(false,
                        "ä½ æ²¡æ‰¾åˆ°è¡€æ¸…ï¼Œæˆ–æ”¾å¼ƒå¤ªå¤šã€‚è™½æœ‰å¯¹è®²æœºé‡Œçš„å¸Œæœ›ï¼Œä½†æ²¡å®ä½“ã€‚\n\n" +
                        "æœ«æ—¥ç»§ç»­ï¼Œäººç±»çš„æ•…äº‹æˆ–è®¸çœŸè¯¥ç»“æŸäº†ã€‚\n\n" +
                        "ã€é—æ†¾ç»“å±€ã€‘\nè§£è°œ: 0/1 | è¡€æ¸…: âœ— | çœŸç›¸: âœ— | ç»“æœ: ç­äº¡"
                    );
                }
            }, 2000);
        }

        // æ¸¸æˆç»“æŸ
        function gameOver(success, message = "") {
            const gameOverScreen = document.getElementById('gameOverScreen');
            const gameOverTitle = document.getElementById('gameOverTitle');
            const gameOverText = document.getElementById('gameOverText');
            
            gameOverScreen.style.display = 'flex';
            
            if (success) {
                gameOverTitle.textContent = 'ä»»åŠ¡å®Œæˆï¼';
                gameOverTitle.style.color = '#44ff44';
            } else {
                gameOverTitle.textContent = 'ä»»åŠ¡å¤±è´¥';
                gameOverTitle.style.color = '#ff4444';
            }
            
            gameOverText.textContent = message;
            
            const stats = document.createElement('div');
            stats.style.marginTop = '20px';
            stats.style.padding = '15px';
            stats.style.background = 'rgba(255,255,255,0.1)';
            stats.style.borderRadius = '10px';
            stats.style.textAlign = 'left';
            stats.style.maxHeight = '200px';
            stats.style.overflowY = 'auto';
            
            const itemsCollected = Object.keys(gameState.inventory).length;
            const healthPercent = gameState.health;
            const sanityPercent = gameState.sanity;
            
            stats.innerHTML = `
                <p style="margin: 5px 0;"><strong>ğŸ“Š æœ€ç»ˆç»Ÿè®¡ï¼š</strong></p>
                <p style="margin: 5px 0;">âœ… è§£è°œå®Œæˆ: ${gameState.puzzlesSolved}/1</p>
                <p style="margin: 5px 0;">ğŸ’ ç‰©å“æ”¶é›†: ${itemsCollected}/8</p>
                <p style="margin: 5px 0;">â¤ï¸ å‰©ä½™ç”Ÿå‘½: ${healthPercent}%</p>
                <p style="margin: 5px 0;">ğŸ§  ç†æ™ºå€¼: ${sanityPercent}%</p>
                <p style="margin: 5px 0;">ğŸ“… ç”Ÿå­˜å¤©æ•°: ${gameState.day}å¤©</p>
                <p style="margin: 5px 0;">ğŸ‘¥ æ•‘åŠ©å¹¸å­˜è€…: ${gameState.flags.savedSurvivor ? 'æ˜¯' : 'å¦'}</p>
                <p style="margin: 5px 0;">ğŸ” æ­éœ²çœŸç›¸: ${gameState.flags.knowsTruth ? 'æ˜¯' : 'å¦'}</p>
            `;
            gameOverText.appendChild(stats);
        }

        // é‡æ–°å¼€å§‹
        function restartGame() {
            location.reload();
        }

        // æ—¶é—´æ¨è¿›
        function advanceTime(hours) {
            const [h, m] = gameState.time.split(':').map(Number);
            let newH = h + hours;
            
            if (newH >= 24) {
                newH -= 24;
                gameState.day++;
            }
            
            gameState.time = `${String(newH).padStart(2, '0')}:${m}`;
            document.getElementById('timeDisplay').textContent = `ç¬¬${gameState.day}å¤© ${gameState.time}`;
        }

        // å®šæœŸäº‹ä»¶ç³»ç»Ÿ
        let lastTimeUpdate = Date.now();
        function gameLoop() {
            const now = Date.now();
            
            if (now - lastTimeUpdate > 10000) { // æ¯10ç§’
                if (gameState.health > 0) {
                    advanceTime(1);
                    updateStats(0, -3, -1);
                    
                    if (Math.random() < 0.15 && gameState.currentScene !== 'shelter') {
                        showWarning("âš ï¸ ä¸§å°¸åœ¨é™„è¿‘æ¸¸è¡ï¼");
                        updateStats(-5, -2, -5);
                    }
                    
                    gameState.storyProgress += 0.5;
                }
                lastTimeUpdate = now;
            }
            
            requestAnimationFrame(gameLoop);
        }

        // ==================== å¼€å‘è€…æ¨¡å¼åŠŸèƒ½ ====================

        let devClickCount = 0;
        let devClickTimer = null;

        function attemptDevAccess() {
            if (gameState.devMode) return;
            
            devClickCount++;
            
            if (devClickTimer) clearTimeout(devClickTimer);
            
            devClickTimer = setTimeout(() => {
                devClickCount = 0;
            }, 3000);
            
            if (devClickCount >= 5) {
                devClickCount = 0;
                showPasswordModal();
            }
        }

        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordHint').textContent = '';
            document.getElementById('passwordInput').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            if (input === '32512') {
                gameState.devMode = true;
                document.getElementById('devModeIndicator').style.display = 'block';
                closePasswordModal();
                showDevMode();
                
                // æ·»åŠ é”®ç›˜å¿«æ·é”®æç¤º
                addStoryText("å¼€å‘è€…æ¨¡å¼å·²æ¿€æ´»ï¼æŒ‰F1å¿«é€Ÿæ‰“å¼€æ§åˆ¶å°ã€‚", "ç³»ç»Ÿ", "success");
            } else {
                document.getElementById('passwordHint').textContent = 'å¯†ç é”™è¯¯ï¼è¯·é‡è¯•ã€‚';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        function showDevMode() {
            document.getElementById('devModeModal').style.display = 'flex';
            updateDevStatus();
        }

        function closeDevMode() {
            document.getElementById('devModeModal').style.display = 'none';
        }

        function devSetHealth() {
            const value = parseInt(document.getElementById('devHealth').value);
            gameState.health = Math.max(0, Math.min(100, value));
            updateStats(0, 0, 0);
            updateDevStatus('ç”Ÿå‘½å€¼å·²è®¾ç½®ä¸º: ' + gameState.health);
        }

        function devSetHunger() {
            const value = parseInt(document.getElementById('devHunger').value);
            gameState.hunger = Math.max(0, Math.min(100, value));
            updateStats(0, 0, 0);
            updateDevStatus('é¥¥é¥¿å€¼å·²è®¾ç½®ä¸º: ' + gameState.hunger);
        }

        function devSetSanity() {
            const value = parseInt(document.getElementById('devSanity').value);
            gameState.sanity = Math.max(0, Math.min(100, value));
            updateStats(0, 0, 0);
            updateDevStatus('ç†æ™ºå€¼å·²è®¾ç½®ä¸º: ' + gameState.sanity);
        }

        function devAddItem() {
            const itemKey = document.getElementById('devItemSelect').value;
            if (!itemKey) {
                updateDevStatus('âš ï¸ è¯·å…ˆé€‰æ‹©ç‰©å“ï¼');
                return;
            }
            
            addInventoryItem(itemKey);
            updateDevStatus('å·²æ·»åŠ ç‰©å“: ' + itemsDB[itemKey].name);
        }

        function devClearInventory() {
            gameState.inventory = {};
            updateInventoryUI();
            updateDevStatus('âœ… èƒŒåŒ…å·²æ¸…ç©ºï¼');
        }

        function devJumpScene() {
            const sceneName = document.getElementById('devSceneSelect').value;
            closeDevMode();
            changeScene(sceneName);
            updateDevStatus('âœ… å·²è·³è½¬åˆ°: ' + storyContent[sceneName].title);
        }

        function devSetFlag(flagName, value) {
            gameState.flags[flagName] = value;
            updateDevStatus(`âœ… æ ‡å¿— ${flagName} è®¾ç½®ä¸º: ${value}`);
        }

        function devTriggerEnding() {
            closeDevMode();
            triggerEnding();
        }

        function devExportState() {
            const stateJson = JSON.stringify(gameState, null, 2);
            console.log('===== æ¸¸æˆçŠ¶æ€å¯¼å‡º =====');
            console.log('å½“å‰æ—¶é—´:', new Date().toLocaleString());
            console.log('æµè§ˆå™¨ä¿¡æ¯:', navigator.userAgent);
            console.log(stateJson);
            updateDevStatus('âœ… æ¸¸æˆçŠ¶æ€å·²å¯¼å‡ºåˆ°æ§åˆ¶å°ï¼');
        }

        function updateDevStatus(message = '') {
            const statusDiv = document.getElementById('devStatus');
            const timestamp = new Date().toLocaleTimeString();
            const activeFlags = Object.entries(gameState.flags).filter(([k,v]) => v).length;
            const totalFlags = Object.keys(gameState.flags).length;
            
            statusDiv.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: bold;">ğŸ“Š å½“å‰çŠ¶æ€ (${timestamp})</div>
                <div>ğŸ® åœºæ™¯: ${gameState.currentTitle}</div>
                <div>â¤ï¸ ç”Ÿå‘½: ${gameState.health} | ğŸ– é¥¥é¥¿: ${gameState.hunger} | ğŸ§  ç†æ™º: ${gameState.sanity}</div>
                <div>ğŸ’ èƒŒåŒ…ç‰©å“: ${Object.keys(gameState.inventory).length}/8</div>
                <div>ğŸ“ˆ è¿›åº¦: ${Math.floor(gameState.storyProgress)}%</div>
                <div>ğŸš© æ ‡å¿—: ${activeFlags}/${totalFlags}</div>
                <div>ğŸ’» å¹³å°: ${getPlatformInfo()}</div>
                ${message ? `<div style="margin-top: 10px; color: #66ff66;">ğŸ“ ${message}</div>` : ''}
            `;
        }

        // è·å–å¹³å°ä¿¡æ¯
        function getPlatformInfo() {
            const ua = navigator.userAgent;
            if (ua.includes('Android')) return 'Android';
            if (ua.includes('iPhone') || ua.includes('iPad') || ua.includes('iPod')) return 'iOS';
            if (ua.includes('Windows')) return 'Windows';
            if (ua.includes('Mac')) return 'macOS';
            if (ua.includes('Linux')) return 'Linux';
            return 'Unknown';
        }

        // é”®ç›˜å¿«æ·é”®ï¼ˆå¼€å‘è€…æ¨¡å¼ï¼‰
        document.addEventListener('keydown', (e) => {
            if (!gameState.devMode) return;
            
            if (e.key === 'Escape') {
                if (document.getElementById('devModeModal').style.display === 'flex') {
                    closeDevMode();
                }
            } else if (e.key === 'F1') {
                e.preventDefault();
                showDevMode();
            }
        });

        // å…¨å±€ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
        let lastClickTime = 0;
        document.addEventListener('click', (e) => {
            const now = Date.now();
            if (now - lastClickTime < 100) { // é˜²æ­¢å¿«é€Ÿè¿ç‚¹
                e.preventDefault();
                e.stopPropagation();
            }
            lastClickTime = now;
        }, true);

        // å¯åŠ¨æ¸¸æˆ
        window.addEventListener('load', () => {
            initGame();
            gameLoop(); // å¯åŠ¨æ¸¸æˆå¾ªç¯
        });

        // é¡µé¢å¯è§æ€§APIï¼ˆæ”¯æŒåå°æš‚åœï¼‰
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœæ¸¸æˆé€»è¾‘
                lastTimeUpdate = Date.now() + 1000000; // è®¾ç½®ä¸€ä¸ªå¾ˆå¤§çš„å€¼
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤
                lastTimeUpdate = Date.now();
            }
        });
    </script>
</body>
</html>
